####################################################

This code is based on a preliminary version of the BSM3G code initiated by:
Andres Florez (Los Andes), Alfredo Gurrola (Vanderbilt) and Amandeep Kalsi (Panjab) 
(See https://github.com/florez/NtupleMaker_740)

It has been extended and further developed by Francesco Romeo (IHEP) and Aniello Spiezia (IHEP).
It has been modified for RunII analysis by Binghuan Li (IHEP)
This version of code is used for 2016 miniAOD v3 && 2017 miniAOD v2 and v1 & 2018 miniAOD  Ntuple production:
####################################################


cmsrel CMSSW_10_2_14
cd CMSSW_10_2_14/src
cmsenv

git cms-init

# set merge limit variable
git config merge.renameLimit 999999

## set up Egamma Tools
## https://twiki.cern.ch/twiki/bin/view/CMS/EgammaMiniAODV2#2018_Preliminary_Energy_Correcti 
git cms-merge-topic cms-egamma:EgammaPostRecoTools #just adds in an extra file to have a setup function to make things easier
git cms-merge-topic cms-egamma:slava77-btvDictFix_10210 #fixes the Run2018D dictionary issue, see https://github.com/cms-sw/cmssw/issues/26182
scram b -j 8
git clone git@github.com:cms-egamma/EgammaAnalysis-ElectronTools.git EgammaAnalysis/ElectronTools/data
cd EgammaAnalysis/ElectronTools/data
git checkout ScalesSmearing2018_Dev
cd -
git cms-merge-topic cms-egamma:EgammaPostRecoTools_dev
scram b -j 8  
         

## set up MET corrections with EE nosie fix
# https://twiki.cern.ch/twiki/bin/view/CMS/MissingETUncertaintyPrescription#Instructions_for_9_4_X_X_9_for_2
git cms-merge-topic cms-met:METFixEE2017_949_v2_backport_to_102X  
scram b -j 8

## set up MetFilters
# https://twiki.cern.ch/twiki/bin/viewauth/CMS/MissingETOptionalFiltersRun2#How_to_run_ecal_BadCalibReducedM
git cms-addpkg RecoMET/METFilters
scram b

## set up DeepTau v2
# https://twiki.cern.ch/twiki/bin/view/CMSPublic/SWGuidePFTauID#Running_of_the_DNN_based_tau_ID
git cms-merge-topic -u cms-tau-pog:CMSSW_10_2_X_tau-pog_DeepTau2017v2
git clone -b DeepTau2017v2_alone https://github.com/cms-tau-pog/RecoTauTag-TrainingFiles.git RecoTauTag/TrainingFiles/data
scram b -j 8
rm -rf RecoTauTag/TrainingFiles/data/.git/ # remove the .git otherwise it exceed the maximum tarball size

## set BSM Framework
git clone https://github.com/BinghuanLi/BSMFramework.git
cd BSMFramework/
git checkout CMSSW_10_2_14
cd ..
scram b -j 8

## add most updated 2018 electron scale&smear #####
## the official maintained RecoEgammaTool.py is not updated, so I do it manually for the moment
## v2 files are taken from https://github.com/cms-data/EgammaAnalysis-ElectronTools/tree/master/ScalesSmearings
cp BSMFramework/BSM3G_TNT_Maker/data/Egamma/*.dat EgammaAnalysis/ElectronTools/data/ScalesSmearings/
cp BSMFramework/BSM3G_TNT_Maker/data/Egamma/EgammaPostRecoTools.py RecoEgamma/EgammaTools/python/

## To Run ##
cd BSMFramework/BSM3G_TNT_Maker/python/
cmsRun miniAOD_MC(RD)2017(2016)(2018).py 

## To Submit Crab jobs ###
cd BSMFramework/BSM3G_TNT_Maker/crab/
python multicrab_MC(DATA)2016(2017)(2018).py

## Notice ###
- Always check HLT, make sure
    HLT you want is contained in TriggerSelector
    ifevtriggers in miniADO_RD(MC).py is set to true (false)

- Please change the absolute path of certain input files in multicrab_MC(DATA)2016(2017)(2018).py
- Please set outLFNDirBase to your DIR path at IHEP Tier 2 farm
  Highly suggest to create an empty DIR as output for the IHEP Tier 2 to Tier 3 Ntuple Handlings
 
